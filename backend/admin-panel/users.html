<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KullanÄ±cÄ± YÃ¶netimi - Admin Panel</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ‘¥</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</h2>
            <div class="user-info">
                <span id="adminUsername"></span>
                <button class="btn btn-logout" id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <div class="content">
            <div class="nav-tabs">
                <a href="/admin" class="tab">ğŸ’ Paketler</a>
                <a href="/admin/users.html" class="tab active">ğŸ‘¥ KullanÄ±cÄ±lar</a>
                <a href="/admin/messages.html" class="tab">ğŸ’¬ Mesajlar</a>
            </div>

            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="KullanÄ±cÄ± ara (isim veya email)...">
                <select id="userTypeFilter" class="user-type-filter">
                    <option value="">TÃ¼m KullanÄ±cÄ±lar</option>
                    <option value="normal">Normal KayÄ±t</option>
                    <option value="manual">Manuel Eklenen</option>
                </select>
                <button class="btn btn-success" id="addBotBtn">+ Destek Botu Ekle</button>
            </div>
            
            <div class="bot-section">
                <h3>Destek BotlarÄ±</h3>
                <div id="botList" class="bot-list"></div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Avatar</th>
                        <th>Ä°sim</th>
                        <th>Email</th>
                        <th>Jeton</th>
                        <th>Durum</th>
                        <th>KayÄ±t Tarihi</th>
                        <th>Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <tr><td colspan="7" class="empty-state">YÃ¼kleniyor...</td></tr>
                </tbody>
            </table>
            
            <!-- Pagination Controls -->
            <div id="paginationControls" class="pagination-controls" style="display: none;">
                <div class="pagination-info">
                    <span id="paginationInfo">Sayfa 1 / 1</span>
                </div>
                <div class="pagination-buttons">
                    <button id="prevPageBtn" class="btn btn-secondary" disabled>â† Ã–nceki</button>
                    <button id="nextPageBtn" class="btn btn-secondary" disabled>Sonraki â†’</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot Modal -->
    <div id="botModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Destek Botu Ekle</h3>
            </div>
            <form id="botForm">
                <div class="input-group">
                    <label>Bot Ä°smi</label>
                    <input type="text" id="botName" required placeholder="Destek">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="botEmail" required placeholder="destek@chatnow.com">
                </div>
                <div class="input-group">
                    <label>HakkÄ±nda</label>
                    <textarea id="botAbout" rows="3" placeholder="MÃ¼ÅŸteri destek botu"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="closeBotModalBtn">Ä°ptal</button>
                    <button type="submit" class="btn btn-success">OluÅŸtur</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ğŸ‘¤ KullanÄ±cÄ± DÃ¼zenle</h3>
            </div>
            <form id="editForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="input-group">
                        <label>Ä°sim *</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="input-group">
                        <label>Soyisim</label>
                        <input type="text" id="editSurname">
                    </div>
                    <div class="input-group">
                        <label>YaÅŸ *</label>
                        <input type="number" id="editAge" required min="18" max="100">
                    </div>
                    <div class="input-group">
                        <label>Åehir *</label>
                        <input type="text" id="editLocation" required>
                    </div>
                    <div class="input-group">
                        <label>Jeton MiktarÄ±</label>
                        <input type="number" id="editDiamonds" required min="0">
                    </div>
                    <div class="input-group">
                        <label>Profil Resmi</label>
                        <input type="url" id="editAvatar" placeholder="https://..." style="margin-bottom:8px;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="file" id="avatarFile" accept="image/*">
                            <button type="button" class="btn btn-primary" id="uploadAvatarBtn">YÃ¼kle</button>
                            <span id="uploadStatus" style="font-size:12px; color:#666;"></span>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label>HakkÄ±nda</label>
                    <textarea id="editAbout" rows="3" placeholder="KullanÄ±cÄ± hakkÄ±nda..."></textarea>
                </div>
                <div class="input-group">
                    <label>Hobiler (virgÃ¼lle ayÄ±r)</label>
                    <input type="text" id="editHobbies" placeholder="MÃ¼zik, Spor, Sinema">
                    <small style="color: #999; font-size: 12px;">Ã–rnek: MÃ¼zik, Spor, Sinema</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="closeEditModalBtn">Ä°ptal</button>
                    <button type="submit" class="btn btn-success">ğŸ’¾ Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let authToken = localStorage.getItem('adminToken');
        let editingUserId = null;
        let currentPage = 1;
        let totalPages = 1;
        let currentSearch = '';
        let currentUserType = '';

        if (!authToken) {
            window.location.href = '/admin';
        }

        document.getElementById('adminUsername').textContent = localStorage.getItem('adminUsername') || 'Admin';

        // Load users with pagination
        async function loadUsers(search = '', page = 1, userType = '') {
            try {
                let url = `${API_URL}/api/admin/users?page=${page}&limit=20`;
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                    currentSearch = search;
                } else {
                    currentSearch = '';
                }
                
                if (userType) {
                    url += `&user_type=${userType}`;
                    currentUserType = userType;
                } else {
                    currentUserType = '';
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error('KullanÄ±cÄ±lar yÃ¼klenemedi');
                }

                const data = await response.json();
                renderUsers(data.users);
                updatePagination(data.pagination);
            } catch (error) {
                console.error(error);
                document.getElementById('usersBody').innerHTML = `
                    <tr><td colspan="7" class="empty-state">Hata: ${error.message}</td></tr>
                `;
            }
        }

        // Update pagination controls
        function updatePagination(pagination) {
            currentPage = pagination.page;
            totalPages = pagination.totalPages;
            
            const paginationControls = document.getElementById('paginationControls');
            const paginationInfo = document.getElementById('paginationInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            if (totalPages > 1) {
                paginationControls.style.display = 'flex';
                paginationInfo.textContent = `Sayfa ${currentPage} / ${totalPages} (Toplam: ${pagination.total} kullanÄ±cÄ±)`;
                
                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;
            } else {
                paginationControls.style.display = 'none';
            }
        }

        // Load bots
        async function loadBots() {
            try {
                const response = await fetch(`${API_URL}/api/admin/support-bots`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const bots = await response.json();
                    displayBots(bots);
                }
            } catch (error) {
                console.error('Bot yÃ¼kleme hatasÄ±:', error);
            }
        }

        // Display bots
        function displayBots(bots) {
            const botList = document.getElementById('botList');
            
            if (bots.length === 0) {
                botList.innerHTML = '<div class="empty-state">HenÃ¼z bot oluÅŸturulmamÄ±ÅŸ</div>';
                return;
            }

            botList.innerHTML = bots.map(bot => `
                <div class="bot-card">
                    <div class="bot-avatar">
                        <img src="${bot.avatar_image ? 
                            (bot.avatar_image.startsWith('data:') ? 
                                bot.avatar_image : 
                                bot.avatar_image.includes('/uploads/') ? 
                                    bot.avatar_image.replace('/uploads/', '/api/admin/thumbnail/') : 
                                    bot.avatar_image) : 
                            'data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><text y=\".9em\" font-size=\"90\">ğŸ¤–</text></svg>'}" 
                             alt="${bot.name}" class="bot-avatar-img">
                        <input type="file" id="botAvatar_${bot._id}" accept="image/*" style="display: none;">
                        <button class="btn btn-sm btn-primary" data-bot-id="${bot._id}">Resim DeÄŸiÅŸtir</button>
                    </div>
                    <div class="bot-info">
                        <h4>${bot.name}</h4>
                        <p>${bot.email}</p>
                        <p>${bot.about || 'Bot aÃ§Ä±klamasÄ± yok'}</p>
                    </div>
                </div>
            `).join('');

            // Bot resmi deÄŸiÅŸtirme event listener'larÄ±
            bots.forEach(bot => {
                const fileInput = document.getElementById(`botAvatar_${bot._id}`);
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        await updateBotAvatar(bot._id, file);
                    }
                });
            });
        }

        // Update bot avatar
        async function updateBotAvatar(botId, file) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_URL}/api/admin/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Bot'un avatar'Ä±nÄ± gÃ¼ncelle
                    const updateResponse = await fetch(`${API_URL}/api/admin/users/${botId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            avatar: data.imageUrl
                        })
                    });

                    if (updateResponse.ok) {
                        alert('Bot resmi gÃ¼ncellendi!');
                        loadBots(); // Bot listesini yenile
                        loadUsers(); // KullanÄ±cÄ± listesini de yenile (bot'lar da gÃ¶rÃ¼nÃ¼r)
                    } else {
                        alert('Bot resmi gÃ¼ncellenemedi');
                    }
                } else {
                    alert('Resim yÃ¼klenemedi');
                }
            } catch (error) {
                console.error('Bot resmi gÃ¼ncelleme hatasÄ±:', error);
                alert('Hata oluÅŸtu');
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">KullanÄ±cÄ± bulunamadÄ±</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        ${user.avatar_image ? 
                            `<img src="${user.avatar_image.startsWith('data:') ? 
                                user.avatar_image : 
                                user.avatar_image.includes('/uploads/') ? 
                                    user.avatar_image.replace('/uploads/', '/api/admin/thumbnail/') : 
                                    user.avatar_image}" 
                                  style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;"
                                  class="user-avatar-img"
                                  loading="lazy">` :
                            `<div style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                ${user.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©'}
                             </div>`
                        }
                    </td>
                    <td><strong>${user.name} ${user.surname || ''}</strong></td>
                    <td>${user.email}</td>
                    <td><strong>${user.diamonds || 0}</strong> ğŸ’</td>
                    <td>
                        <span class="status-badge ${user.is_online ? 'status-active' : 'status-inactive'}">
                            ${user.is_online ? 'Online' : 'Offline'}
                        </span>
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString('tr-TR')}</td>
                    <td>
                        <button class="btn btn-primary btn-small edit-user-btn" data-id="${user._id}" data-diamonds="${user.diamonds}">
                            DÃ¼zenle
                        </button>
                        <button class="btn btn-danger btn-small delete-user-btn" data-id="${user._id}" data-name="${user.name}">
                            Sil
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Search
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadUsers(e.target.value, 1, currentUserType); // Reset to page 1 when searching
            }, 300);
        });

        // Pagination button events
        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                loadUsers(currentSearch, currentPage - 1, currentUserType);
            }
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            if (currentPage < totalPages) {
                loadUsers(currentSearch, currentPage + 1, currentUserType);
            }
        });

        // User type filter event
        document.getElementById('userTypeFilter').addEventListener('change', (e) => {
            loadUsers(currentSearch, 1, e.target.value); // Reset to page 1 when filtering
        });

        // Bot Modal
        document.getElementById('addBotBtn').addEventListener('click', () => {
            document.getElementById('botModal').style.display = 'flex';
        });

        document.getElementById('closeBotModalBtn').addEventListener('click', () => {
            document.getElementById('botModal').style.display = 'none';
        });

        document.getElementById('botForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const botData = {
                name: document.getElementById('botName').value,
                email: document.getElementById('botEmail').value,
                about: document.getElementById('botAbout').value
            };

            try {
                const response = await fetch(`${API_URL}/api/admin/support-bots`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(botData)
                });

                if (response.ok) {
                    document.getElementById('botModal').style.display = 'none';
                    document.getElementById('botForm').reset();
                    loadUsers();
                    alert('Bot oluÅŸturuldu!');
                } else {
                    const data = await response.json();
                    alert(data.error || 'Bot oluÅŸturulamadÄ±');
                }
            } catch (error) {
                alert('Hata oluÅŸtu');
            }
        });

        // Edit User
        document.getElementById('usersBody').addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-user-btn')) {
                editingUserId = e.target.getAttribute('data-id');
                
                try {
                    // Fetch full user data
                    const response = await fetch(`${API_URL}/api/admin/users/${editingUserId}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });

                    if (response.ok) {
                        const user = await response.json();
                        
                        // Fill form
                        document.getElementById('editName').value = user.name || '';
                        document.getElementById('editSurname').value = user.surname || '';
                        document.getElementById('editAge').value = user.age || 18;
                        document.getElementById('editLocation').value = user.location || '';
                        document.getElementById('editDiamonds').value = user.diamonds || 0;
                        document.getElementById('editAvatar').value = user.avatar || '';
                        document.getElementById('editAbout').value = user.about || '';
                        document.getElementById('editHobbies').value = Array.isArray(user.hobbies) ? user.hobbies.join(', ') : '';
                        
                        document.getElementById('editModal').style.display = 'flex';
                    } else {
                        alert('KullanÄ±cÄ± bilgileri yÃ¼klenemedi');
                    }
                } catch (error) {
                    alert('Hata oluÅŸtu');
                }
            }
        });

        document.getElementById('closeEditModalBtn').addEventListener('click', () => {
            document.getElementById('editModal').style.display = 'none';
        });

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const hobbiesText = document.getElementById('editHobbies').value;
            const hobbies = hobbiesText ? hobbiesText.split(',').map(h => h.trim()).filter(h => h) : [];

            const userData = {
                name: document.getElementById('editName').value,
                surname: document.getElementById('editSurname').value,
                age: parseInt(document.getElementById('editAge').value),
                location: document.getElementById('editLocation').value,
                diamonds: parseInt(document.getElementById('editDiamonds').value),
                avatar: document.getElementById('editAvatar').value,
                about: document.getElementById('editAbout').value,
                hobbies: hobbies
            };

            try {
                const response = await fetch(`${API_URL}/api/admin/users/${editingUserId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    document.getElementById('editModal').style.display = 'none';
                    loadUsers();
                    alert('âœ… KullanÄ±cÄ± baÅŸarÄ±yla gÃ¼ncellendi!');
                } else {
                    const data = await response.json();
                    alert('âŒ GÃ¼ncelleme baÅŸarÄ±sÄ±z: ' + (data.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                alert('âŒ Hata oluÅŸtu: ' + error.message);
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', logout);

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUsername');
            window.location.href = '/admin';
        }

        // Upload avatar
        document.getElementById('uploadAvatarBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('avatarFile');
            const statusEl = document.getElementById('uploadStatus');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('LÃ¼tfen bir resim seÃ§in');
                return;
            }

            const file = fileInput.files[0];
            
            // Resim boyutunu kontrol et (2MB limit)
            if (file.size > 2 * 1024 * 1024) {
                alert('Resim Ã§ok bÃ¼yÃ¼k! Maksimum 2MB olmalÄ±.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            statusEl.textContent = 'YÃ¼kleniyor...';

            try {
                const response = await fetch(`${API_URL}/api/admin/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('editAvatar').value = data.url;
                    statusEl.textContent = 'YÃ¼klendi!';
                } else {
                    statusEl.textContent = 'Hata: ' + (data.error || 'YÃ¼klenemedi');
                }
            } catch (error) {
                statusEl.textContent = 'Hata: ' + error.message;
            }
        });

        // Resim hata event listener'larÄ± - sonsuz dÃ¶ngÃ¼yÃ¼ Ã¶nle
        document.addEventListener('error', (e) => {
            if (e.target.classList.contains('bot-avatar-img')) {
                // Sadece bir kez fallback yap
                if (!e.target.dataset.fallbackApplied) {
                    e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ¤–</text></svg>';
                    e.target.dataset.fallbackApplied = 'true';
                }
            } else if (e.target.classList.contains('user-avatar-img')) {
                // Sadece bir kez fallback yap
                if (!e.target.dataset.fallbackApplied) {
                    e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ‘¤</text></svg>';
                    e.target.dataset.fallbackApplied = 'true';
                }
            }
        }, true);

        // Bot resim deÄŸiÅŸtirme event listener'larÄ±
        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-bot-id]')) {
                const botId = e.target.getAttribute('data-bot-id');
                const fileInput = document.getElementById(`botAvatar_${botId}`);
                if (fileInput) {
                    fileInput.click();
                }
            }
        });

        // Delete user functionality
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-user-btn')) {
                const userId = e.target.getAttribute('data-id');
                const userName = e.target.getAttribute('data-name');
                
                if (confirm(`"${userName}" kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinizden emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz ve kullanÄ±cÄ±nÄ±n tÃ¼m mesajlarÄ±, sohbetleri ve engellemeleri silinecektir.`)) {
                    try {
                        const response = await fetch(`${API_URL}/api/admin/users/${userId}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        
                        if (response.ok) {
                            alert('KullanÄ±cÄ± baÅŸarÄ±yla silindi');
                            loadUsers(currentSearch, currentPage, currentUserType); // Reload current page
                        } else {
                            const error = await response.json();
                            alert(`Hata: ${error.error}`);
                        }
                    } catch (error) {
                        console.error('Delete user error:', error);
                        alert('KullanÄ±cÄ± silinirken hata oluÅŸtu');
                    }
                }
            }
        });

        // Load on start
        loadUsers();
        loadBots();
    </script>
</body>
</html>

